"use strict";!function(e,t){var i=ax5.util,s=function(){var e;t&&t.call(this),this.queue=[],this.config={clickEventName:"click",theme:"default",file_types:"*/*"},this.target=null,this.selectedFile=null,this.uploadedFile=null,e=this.config,this.init=function(){console.log(e.target),this.target=$(e.target),this.target.html(this.__get_layout()),this.els={container:this.target.find('[data-ui-els="container"]'),preview:this.target.find('[data-ui-els="preview"]'),"preview-img":this.target.find('[data-ui-els="preview-img"]'),"input-file":this.target.find('[data-ui-els="input-file"]'),progress:this.target.find('[data-ui-els="progress"]'),"progress-bar":this.target.find('[data-ui-els="progress-bar"]')},this.els.preview.bind("click",function(){this.__request_select_file()}.bind(this)),this.els["input-file"].bind("change",function(e){this.__on_select_file(e||window.event)}.bind(this)),function(){var e,t=this.els.container,i=this.els["preview-img"],s=this;console.log(t.get(0)),t.get(0).addEventListener("dragover",function(s){s.stopPropagation(),s.preventDefault(),i.hide(),e&&clearTimeout(e),t.addClass("dragover")},!1),t.get(0).addEventListener("dragleave",function(s){s.stopPropagation(),s.preventDefault(),e&&clearTimeout(e),e=setTimeout(function(){i.show()},100),t.removeClass("dragover")},!1),t.get(0).addEventListener("drop",function(e){e.stopPropagation(),e.preventDefault(),t.removeClass("dragover"),s.__on_select_file(e||window.event)},!1)}.call(this),setTimeout(function(){this.__set_size_layout()}.bind(this),1)},this.__get_layout=function(){var t=[],i="",s=e.file_types;return t.push('<div class="ax5-ui-single-uploader '+e.theme+'" data-ui-els="container">'),t.push('<div class="upload-preview" data-ui-els="preview">'),t.push('<img class="upload-preview-img" data-ui-els="preview-img" src="" style="display:none;width:100%;height:100%;" />'),t.push('<span class="empty-msg">'+e.empty_msg+"<span>"),t.push("</div>"),t.push('<div class="ax5-ui-progress '+(e.progress_theme||"")+'" data-ui-els="progress" style="display: none;"><div class="progress-bar" data-ui-els="progress-bar"></div></div>'),t.push('<input type="file" '+i+' accept="'+s+'" capture="camera" data-ui-els="input-file" />'),t.push("</div>"),t.join("")},this.__set_size_layout=this.align=function(){var e=20,t=this.els.progress.height(),i=this.els.container.width(),s=this.els.container.height();0!=i&&0!=s&&this.els.progress.css({left:e,top:s/2-t/2,width:i-2*e})},this.__request_select_file=function(){return e.before_select_file&&!e.before_select_file.call()?!1:void(window.imagePicker?window.imagePicker.getPictures(function(e){for(var t=0;t<e.length;t++)console.log("Image URI: "+e[t]);_this.__on_select_file(e)},function(e){console.log("Error: "+e)}):this.els["input-file"].trigger("click"))},this.__on_select_file=function(t){var i,s=this.target.id,n=this.els["preview-img"].get(0);if(console.log(t),"dataTransfer"in t?i=t.dataTransfer.files[0]:"target"in t?i=t.target.files[0]:t&&(i=t[0]),!i)return!1;if(this.selected_file=i,function(e){function t(t,i,s){var n={},a=new Image;a.src=t.src,a.onload=function(){this.width>this.height?this.height>s?(n={width:this.width*(s/this.height),height:s},n.left=(i-n.width)/2):(n={width:this.width,height:this.height},n.top=(s-n.height)/2):this.width>i?(n={height:this.height*(i/this.width),width:i},n.top=(s-n.height)/2):(n={width:this.width,height:this.height},n.left=(i-n.width)/2),console.log(n),e.els["preview-img"].css(n)}}if(e.els["preview-img"].css({display:"block"}),window.imagePicker)n.src=i,t(n,e.els.container.width(),e.els.container.height());else{var a=new FileReader(s);a.onloadend=function(){try{n.src=a.result,t(n,e.els.container.width(),e.els.container.height())}catch(i){console.log(i)}},i&&a.readAsDataURL(i)}}(this),e.on_event){var a={action:"fileselect",file:i};e.on_event.call(a,a)}},this.upload=function(){if(!this.selected_file){if(e.on_event){var t={action:"error",error:ax5.info.get_error("single-uploader","460","upload")};e.on_event.call(t,t)}return this}var s=new FormData,n=this.els["progress-bar"];this.els.progress.css({display:"block"}),n.css({width:"0%"}),window.imagePicker?s.append(e.upload_http.filename_param_key,this.selected_file):s.append(e.upload_http.filename_param_key,this.selected_file);for(var a in e.upload_http.data)s.append(a,e.upload_http.data[a]);this.xhr=new XMLHttpRequest,this.xhr.open(e.upload_http.method,e.upload_http.url,!0),this.xhr.onload=function(e){var t=e.target.response;try{"string"==typeof t&&(t=i.parse_json(t))}catch(e){return console.log(e),!1}return t.error?(console.log(t.error),!1):void _this.upload_complete(t)},this.xhr.upload.onprogress=function(e){n.css({width:i.number(e.loaded/e.total*100,{round:2})+"%"}),e.lengthComputable&&e.loaded>=e.total&&setTimeout(function(){_this.els.progress.css({display:"none"})},300)},this.xhr.send(s)},this.upload_complete=function(t){if(this.selected_file=null,this.uploaded_file=t,this.els.container.addClass("uploaded"),e.on_event){var i={action:"uploaded",file:t};e.on_event.call(i,i)}},this.set_uploaded_file=function(e){this.uploaded_file=e,this.uploaded_file?this.els.container.addClass("uploaded"):this.els.container.removeClass("uploaded")},this.set_preview_img=function(e){e?this.els["preview-img"].attr({src:e}):this.els["preview-img"].attr({src:null})},this.main=function(){arguments&&i.isObject(arguments[0])&&this.setConfig(arguments[0])}.apply(this,arguments)};e.uploader=function(){return i.isFunction(t)&&(s.prototype=new t),s}()}(ax5.ui,ax5.ui.root);