"use strict";!function(e,t){var i=ax5.util,s=function(){var s;t&&t.call(this),this.queue=[],this.config={clickEventName:"click",theme:"default",file_types:"*/*"},this.target=null,this.selectedFile=null,this.uploadedFile=null,s=this.config,this.init=function(){this.target=$(s.target),this.target.html(this.__get_layout()),this.els={container:this.target.find('[data-ui-els="container"]'),preview:this.target.find('[data-ui-els="preview"]'),"preview-img":this.target.find('[data-ui-els="preview-img"]'),"input-file":this.target.find('[data-ui-els="input-file"]'),progress:this.target.find('[data-ui-els="progress"]'),"progress-bar":this.target.find('[data-ui-els="progress-bar"]')},this.els.preview.bind("click",function(){this.__request_select_file()}.bind(this)),this.els["input-file"].bind("change",function(e){this.__on_select_file(e||window.event)}.bind(this)),function(){var e,t=this.els.container,i=this.els["preview-img"],s=this;t.get(0).addEventListener("dragover",function(s){s.stopPropagation(),s.preventDefault(),i.hide(),e&&clearTimeout(e),t.addClass("dragover")},!1),t.get(0).addEventListener("dragleave",function(s){s.stopPropagation(),s.preventDefault(),e&&clearTimeout(e),e=setTimeout(function(){i.show()},100),t.removeClass("dragover")},!1),t.get(0).addEventListener("drop",function(e){e.stopPropagation(),e.preventDefault(),t.removeClass("dragover"),s.__on_select_file(e||window.event)},!1)}.call(this),setTimeout(function(){this.__set_size_layout()}.bind(this),1)},this.__get_layout=function(){var e=[],t="",i=s.file_types;return e.push('<div class="ax5-ui-single-uploader '+s.theme+'" data-ui-els="container">'),e.push('<div class="upload-preview" data-ui-els="preview">'),e.push('<img class="upload-preview-img" data-ui-els="preview-img" src="" style="display:none;width:100%;height:100%;" />'),e.push('<span class="empty-msg">'+s.empty_msg+"<span>"),e.push("</div>"),e.push('<div class="ax5-ui-progress '+(s.progress_theme||"")+'" data-ui-els="progress" style="display: none;"><div class="progress-bar" data-ui-els="progress-bar"></div></div>'),e.push('<input type="file" '+t+' accept="'+i+'" capture="camera" data-ui-els="input-file" />'),e.push("</div>"),e.join("")},this.__set_size_layout=this.align=function(){var e=20,t=this.els.progress.height(),i=this.els.container.width(),s=this.els.container.height();0!=i&&0!=s&&this.els.progress.css({left:e,top:s/2-t/2,width:i-2*e})},this.__request_select_file=function(){return s.before_select_file&&!s.before_select_file.call()?!1:void(window.imagePicker?window.imagePicker.getPictures(function(e){for(var t=0;t<e.length;t++)console.log("Image URI: "+e[t]);_this.__on_select_file(e)},function(e){console.log("Error: "+e)}):this.els["input-file"].trigger("click"))},this.__on_select_file=function(e){var t,i=this.target.id,a=this.els["preview-img"].get(0);if("dataTransfer"in e?t=e.dataTransfer.files[0]:"target"in e?t=e.target.files[0]:e&&(t=e[0]),!t)return!1;if(this.selected_file=t,function(e){function s(t,i,s){var a={},n=new Image;n.src=t.src,n.onload=function(){this.width>this.height?this.height>s?(a={width:this.width*(s/this.height),height:s},a.left=(i-a.width)/2):(a={width:this.width,height:this.height},a.top=(s-a.height)/2):this.width>i?(a={height:this.height*(i/this.width),width:i},a.top=(s-a.height)/2):(a={width:this.width,height:this.height},a.left=(i-a.width)/2),console.log(a),e.els["preview-img"].css(a)}}if(e.els["preview-img"].css({display:"block"}),window.imagePicker)a.src=t,s(a,e.els.container.width(),e.els.container.height());else{var n=new FileReader(i);n.onloadend=function(){try{a.src=n.result,s(a,e.els.container.width(),e.els.container.height())}catch(t){console.log(t)}},t&&n.readAsDataURL(t)}}(this),s.on_event){var n={action:"fileselect",file:t};s.on_event.call(n,n)}},this.upload=function(){var e=this;if(!this.selected_file){if(s.on_event){var t={action:"error",error:ax5.info.get_error("single-uploader","460","upload")};s.on_event.call(t,t)}return this}var a=new FormData,n=this.els["progress-bar"];this.els.progress.css({display:"block"}),n.css({width:"0%"}),window.imagePicker?a.append(s.upload_http.filename_param_key,this.selected_file):a.append(s.upload_http.filename_param_key,this.selected_file);for(var r in s.upload_http.data)a.append(r,s.upload_http.data[r]);this.xhr=new XMLHttpRequest,this.xhr.open(s.upload_http.method,s.upload_http.url,!0),this.xhr.onload=function(t){var s=t.target.response;try{"string"==typeof s&&(s=i.parseJson(s))}catch(t){return console.log(t),!1}return s.error?(console.log(s.error),!1):void e.upload_complete(s)},this.xhr.upload.onprogress=function(t){n.css({width:i.number(t.loaded/t.total*100,{round:2})+"%"}),t.lengthComputable&&t.loaded>=t.total&&setTimeout(function(){e.els.progress.css({display:"none"})},300)},this.xhr.send(a)},this.upload_complete=function(e){if(this.selected_file=null,this.uploaded_file=e,this.els.container.addClass("uploaded"),s.on_event){var t={action:"uploaded",file:e};s.on_event.call(t,t)}},this.set_uploaded_file=function(e){this.uploaded_file=e,this.uploaded_file?this.els.container.addClass("uploaded"):this.els.container.removeClass("uploaded")},this.set_preview_img=function(e){e?this.els["preview-img"].attr({src:e}).show():this.els["preview-img"].attr({src:null}).hide()},this.main=function(){e.uploader_instance=e.uploader_instance||[],e.uploader_instance.push(this),arguments&&i.isObject(arguments[0])&&this.setConfig(arguments[0])}.apply(this,arguments)};e.uploader=function(){return i.isFunction(t)&&(s.prototype=new t),s}()}(ax5.ui,ax5.ui.root);